import sys
import random
import json
import datetime
from pathlib import Path
from PySide6.QtWidgets import (QApplication, QMainWindow, QWidget, QVBoxLayout, QHBoxLayout,
                               QLabel, QPushButton, QSpinBox, QMessageBox, QTabWidget, 
                               QProgressBar, QGroupBox, QComboBox, QCheckBox)
from PySide6.QtCore import Qt, QTimer, QPropertyAnimation, QEasingCurve, QRect, QDate
from PySide6.QtGui import QFont, QPixmap, QColor, QGuiApplication, QIcon
import pyqtgraph as pg
import pygame
from collections import deque


class CasinoGame(QMainWindow):
    def __init__(self):
        super().__init__()
        self.setWindowTitle("Lucky Casino Deluxe")
        self.resize(1000, 750)

        # –¶–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ –æ–∫–Ω–∞
        screen = QGuiApplication.primaryScreen().geometry()
        x = (screen.width() - self.width()) // 2
        y = (screen.height() - self.height()) // 2
        self.move(x, y)

        # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∑–≤—É–∫–æ–≤
        pygame.mixer.init()
        try:
            self.spin_sound = pygame.mixer.Sound("spin.wav")
            self.win_sound = pygame.mixer.Sound("win.wav")
            self.lose_sound = pygame.mixer.Sound("lose.wav")
            self.jackpot_sound = pygame.mixer.Sound("jackpot.wav")
        except:
            class DummySound:
                def play(self): pass

            self.spin_sound = self.win_sound = self.lose_sound = self.jackpot_sound = DummySound()

        # –ò–≥—Ä–æ–≤—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
        self.balance = 1000
        self.current_bet = 10
        self.last_win = 0
        self.game_active = False
        self.slot_results = [0, 0, 0]
        self.history = []
        self.balance_history = [self.balance]
        
        # –°–∏—Å—Ç–µ–º–∞ —É—Ä–æ–≤–Ω–µ–π
        self.level = 1
        self.exp = 0
        self.exp_to_next_level = 100
        
        # –î–æ—Å—Ç–∏–∂–µ–Ω–∏—è
        self.achievements = {
            "first_win": False,
            "big_win": False,
            "jackpot": False,
            "high_roller": False,
            "veteran": False
        }
        
        # –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
        self.stats = {
            "total_spins": 0,
            "total_wins": 0,
            "total_losses": 0,
            "max_win": 0,
            "total_won": 0,
            "total_lost": 0
        }
        
        # –ï–∂–µ–¥–Ω–µ–≤–Ω—ã–µ –±–æ–Ω—É—Å—ã
        self.last_bonus_date = None
        self.bonus_streak = 0
        
        # –ù–∞—Å—Ç—Ä–æ–π–∫–∏
        self.settings = {
            "sound": True,
            "music": True,
            "theme": "light",
            "animations": True
        }
        
        # –ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–π
        self.load_game()

        # –û—Å–Ω–æ–≤–Ω–æ–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
        self.setup_ui()

        # –¢–∞–π–º–µ—Ä –¥–ª—è –∞–Ω–∏–º–∞—Ü–∏–∏
        self.spin_timer = QTimer()
        self.spin_timer.timeout.connect(self.update_slot_animation)
        self.spin_counter = 0
        self.spin_duration = 30
        
        # –ê–Ω–∏–º–∞—Ü–∏–æ–Ω–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
        self.slot_animation_values = [0, 0, 0]
        self.win_animation_value = 0
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –µ–∂–µ–¥–Ω–µ–≤–Ω–æ–≥–æ –±–æ–Ω—É—Å–∞
        self.check_daily_bonus()

    def setup_ui(self):
        # –ì–ª–∞–≤–Ω—ã–π –≤–∏–¥–∂–µ—Ç
        central_widget = QWidget()
        self.setCentralWidget(central_widget)

        # –û—Å–Ω–æ–≤–Ω–æ–π –º–∞–∫–µ—Ç
        main_layout = QHBoxLayout(central_widget)

        # –õ–µ–≤–∞—è –ø–∞–Ω–µ–ª—å (—É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ)
        left_panel = QWidget()
        left_layout = QVBoxLayout(left_panel)
        left_panel.setFixedWidth(300)

        # –ü—Ä–∞–≤–∞—è –ø–∞–Ω–µ–ª—å (–∏–≥—Ä–æ–≤–æ–µ –ø–æ–ª–µ)
        right_panel = QWidget()
        right_layout = QVBoxLayout(right_panel)

        main_layout.addWidget(left_panel)
        main_layout.addWidget(right_panel)

        # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–µ–≤–æ–π –ø–∞–Ω–µ–ª–∏
        self.setup_left_panel(left_layout)

        # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø—Ä–∞–≤–æ–π –ø–∞–Ω–µ–ª–∏
        self.setup_right_panel(right_layout)

        # –°—Ç–∏–ª–∏–∑–∞—Ü–∏—è
        self.apply_theme()

    def setup_left_panel(self, layout):
        # –õ–æ–≥–æ—Ç–∏–ø
        logo = QLabel("LUCKY CASINO DELUXE")
        logo.setAlignment(Qt.AlignCenter)
        logo.setFont(QFont("Arial", 18, QFont.Bold))
        layout.addWidget(logo)

        # –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± –∏–≥—Ä–æ–∫–µ
        player_group = QGroupBox("–ò–≥—Ä–æ–∫")
        player_layout = QVBoxLayout()
        
        # –£—Ä–æ–≤–µ–Ω—å –∏ –ø—Ä–æ–≥—Ä–µ—Å—Å
        self.level_label = QLabel(f"–£—Ä–æ–≤–µ–Ω—å: {self.level}")
        self.level_label.setFont(QFont("Arial", 12))
        player_layout.addWidget(self.level_label)
        
        self.exp_bar = QProgressBar()
        self.exp_bar.setRange(0, self.exp_to_next_level)
        self.exp_bar.setValue(self.exp)
        self.exp_bar.setFormat("–û–ø—ã—Ç: %v/%m")
        player_layout.addWidget(self.exp_bar)
        
        # –ë–∞–ª–∞–Ω—Å
        self.balance_label = QLabel(f"–ë–∞–ª–∞–Ω—Å: ${self.balance:,}")
        self.balance_label.setFont(QFont("Arial", 14, QFont.Bold))
        player_layout.addWidget(self.balance_label)

        # –ü–æ—Å–ª–µ–¥–Ω–∏–π –≤—ã–∏–≥—Ä—ã—à
        self.last_win_label = QLabel(f"–ü–æ—Å–ª–µ–¥–Ω–∏–π –≤—ã–∏–≥—Ä—ã—à: ${self.last_win:,}")
        self.last_win_label.setFont(QFont("Arial", 12))
        player_layout.addWidget(self.last_win_label)
        
        player_group.setLayout(player_layout)
        layout.addWidget(player_group)

        layout.addSpacing(10)

        # –°—Ç–∞–≤–∫–∞
        bet_group = QGroupBox("–°—Ç–∞–≤–∫–∞")
        bet_layout = QVBoxLayout()
        
        bet_label = QLabel("–†–∞–∑–º–µ—Ä —Å—Ç–∞–≤–∫–∏:")
        bet_label.setFont(QFont("Arial", 12))
        bet_layout.addWidget(bet_label)

        self.bet_spinbox = QSpinBox()
        self.bet_spinbox.setRange(1, min(10000, self.balance))
        self.bet_spinbox.setValue(self.current_bet)
        self.bet_spinbox.setSingleStep(10)
        self.bet_spinbox.valueChanged.connect(self.update_bet)
        bet_layout.addWidget(self.bet_spinbox)

        # –ö–Ω–æ–ø–∫–∏ –±—ã—Å—Ç—Ä–æ–π —Å—Ç–∞–≤–∫–∏
        bet_buttons = QHBoxLayout()
        for amount in [10, 50, 100, "Max"]:
            btn = QPushButton(str(amount))
            if amount == "Max":
                btn.clicked.connect(lambda: self.set_bet(self.balance))
            else:
                btn.clicked.connect(lambda _, amt=amount: self.set_bet(amt))
            bet_buttons.addWidget(btn)
        bet_layout.addLayout(bet_buttons)
        
        bet_group.setLayout(bet_layout)
        layout.addWidget(bet_group)

        # –ö–Ω–æ–ø–∫–∞ Spin
        self.spin_button = QPushButton("SPIN!")
        self.spin_button.setFont(QFont("Arial", 16, QFont.Bold))
        self.spin_button.clicked.connect(self.start_spin)
        layout.addWidget(self.spin_button)

        layout.addSpacing(10)

        # –ò—Å—Ç–æ—Ä–∏—è
        history_group = QGroupBox("–ò—Å—Ç–æ—Ä–∏—è –∏–≥—Ä")
        history_layout = QVBoxLayout()
        
        self.history_display = QLabel("")
        self.history_display.setFont(QFont("Arial", 10))
        self.history_display.setAlignment(Qt.AlignTop)
        history_layout.addWidget(self.history_display)
        
        history_group.setLayout(history_layout)
        layout.addWidget(history_group)

        # –ö–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
        buttons_layout = QHBoxLayout()
        
        reset_btn = QPushButton("–°–±—Ä–æ—Å")
        reset_btn.clicked.connect(self.reset_game)
        buttons_layout.addWidget(reset_btn)
        
        save_btn = QPushButton("–°–æ—Ö—Ä–∞–Ω–∏—Ç—å")
        save_btn.clicked.connect(self.save_game)
        buttons_layout.addWidget(save_btn)
        
        settings_btn = QPushButton("–ù–∞—Å—Ç—Ä–æ–π–∫–∏")
        settings_btn.clicked.connect(self.show_settings)
        buttons_layout.addWidget(settings_btn)
        
        layout.addLayout(buttons_layout)

        layout.addStretch()

    def setup_right_panel(self, layout):
        # –í–∫–ª–∞–¥–∫–∏
        tabs = QTabWidget()
        
        # –í–∫–ª–∞–¥–∫–∞ —Å–ª–æ—Ç–æ–≤
        slot_tab = QWidget()
        slot_layout = QVBoxLayout()
        
        # –°–ª–æ—Ç—ã
        slots_layout = QHBoxLayout()
        self.slot_labels = []

        for i in range(3):
            slot = QLabel()
            slot.setAlignment(Qt.AlignCenter)
            slot.setFixedSize(180, 180)
            self.slot_labels.append(slot)
            slots_layout.addWidget(slot)

        slot_layout.addLayout(slots_layout)
        
        # –ê–Ω–∏–º–∞—Ü–∏—è –≤—ã–∏–≥—Ä—ã—à–∞
        self.win_animation = QLabel("")
        self.win_animation.setAlignment(Qt.AlignCenter)
        self.win_animation.setFont(QFont("Arial", 24, QFont.Bold))
        self.win_animation.hide()
        slot_layout.addWidget(self.win_animation)
        
        # –ì—Ä–∞—Ñ–∏–∫ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
        self.plot_widget = pg.PlotWidget()
        self.plot_widget.setBackground('#f0f0f0')
        self.plot_widget.setTitle("–ò—Å—Ç–æ—Ä–∏—è –±–∞–ª–∞–Ω—Å–∞", color="#333")
        self.plot_widget.setLabel('left', "–ë–∞–ª–∞–Ω—Å")
        self.plot_widget.setLabel('bottom', "–ò–≥—Ä—ã")
        self.plot_widget.showGrid(x=True, y=True, alpha=0.3)
        self.plot_line = self.plot_widget.plot(self.balance_history, pen=pg.mkPen(color='blue', width=2))
        slot_layout.addWidget(self.plot_widget)
        
        slot_tab.setLayout(slot_layout)
        tabs.addTab(slot_tab, "–°–ª–æ—Ç—ã")
        
        # –í–∫–ª–∞–¥–∫–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
        stats_tab = QWidget()
        stats_layout = QVBoxLayout()
        
        stats_group = QGroupBox("–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞")
        stats_inner_layout = QVBoxLayout()
        
        self.stats_labels = {
            "total_spins": QLabel(f"–í—Å–µ–≥–æ —Å–ø–∏–Ω–æ–≤: {self.stats['total_spins']}"),
            "total_wins": QLabel(f"–ü–æ–±–µ–¥: {self.stats['total_wins']}"),
            "total_losses": QLabel(f"–ü–æ—Ä–∞–∂–µ–Ω–∏–π: {self.stats['total_losses']}"),
            "win_rate": QLabel(f"–ü—Ä–æ—Ü–µ–Ω—Ç –ø–æ–±–µ–¥: {self.calculate_win_rate():.1f}%"),
            "max_win": QLabel(f"–ú–∞–∫—Å. –≤—ã–∏–≥—Ä—ã—à: ${self.stats['max_win']:,}"),
            "total_won": QLabel(f"–í—Å–µ–≥–æ –≤—ã–∏–≥—Ä–∞–Ω–æ: ${self.stats['total_won']:,}"),
            "total_lost": QLabel(f"–í—Å–µ–≥–æ –ø—Ä–æ–∏–≥—Ä–∞–Ω–æ: ${self.stats['total_lost']:,}")
        }
        
        for label in self.stats_labels.values():
            label.setFont(QFont("Arial", 12))
            stats_inner_layout.addWidget(label)
        
        stats_group.setLayout(stats_inner_layout)
        stats_layout.addWidget(stats_group)
        
        # –î–æ—Å—Ç–∏–∂–µ–Ω–∏—è
        achievements_group = QGroupBox("–î–æ—Å—Ç–∏–∂–µ–Ω–∏—è")
        achievements_layout = QVBoxLayout()
        
        self.achievement_labels = {
            "first_win": QLabel("–ü–µ—Ä–≤–∞—è –ø–æ–±–µ–¥–∞: ‚ùå"),
            "big_win": QLabel("–ë–æ–ª—å—à–æ–π –≤—ã–∏–≥—Ä—ã—à (500+): ‚ùå"),
            "jackpot": QLabel("–î–∂–µ–∫–ø–æ—Ç (777): ‚ùå"),
            "high_roller": QLabel("–í—ã—Å–æ–∫–∞—è —Å—Ç–∞–≤–∫–∞ (1000+): ‚ùå"),
            "veteran": QLabel("–í–µ—Ç–µ—Ä–∞–Ω (100 —Å–ø–∏–Ω–æ–≤): ‚ùå")
        }
        
        for label in self.achievement_labels.values():
            label.setFont(QFont("Arial", 10))
            achievements_layout.addWidget(label)
        
        achievements_group.setLayout(achievements_layout)
        stats_layout.addWidget(achievements_group)
        
        stats_tab.setLayout(stats_layout)
        tabs.addTab(stats_tab, "–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞")
        
        # –í–∫–ª–∞–¥–∫–∞ –º–∏–Ω–∏-–∏–≥—Ä
        minigame_tab = QWidget()
        minigame_layout = QVBoxLayout()
        
        minigame_label = QLabel("–ú–∏–Ω–∏-–∏–≥—Ä—ã (—Å–∫–æ—Ä–æ!)")
        minigame_label.setAlignment(Qt.AlignCenter)
        minigame_layout.addWidget(minigame_label)
        
        minigame_tab.setLayout(minigame_layout)
        tabs.addTab(minigame_tab, "–ú–∏–Ω–∏-–∏–≥—Ä—ã")
        
        layout.addWidget(tabs)
        
        self.update_slot_display()
        self.update_achievements_display()

    def apply_theme(self):
        if self.settings["theme"] == "light":
            self.setStyleSheet("""
                QMainWindow {
                    background: #f5f5f5;
                }
                QLabel {
                    color: #333;
                }
                QPushButton {
                    background: #4CAF50;
                    color: white;
                    border: none;
                    padding: 8px;
                    border-radius: 4px;
                    font-weight: bold;
                }
                QPushButton:hover {
                    background: #45a049;
                }
                QSpinBox {
                    padding: 5px;
                }
                QGroupBox {
                    border: 1px solid #ccc;
                    border-radius: 5px;
                    margin-top: 10px;
                }
                QGroupBox::title {
                    subcontrol-origin: margin;
                    left: 10px;
                    padding: 0 3px;
                }
                QTabWidget::pane {
                    border: 1px solid #ccc;
                    background: #f0f0f0;
                }
                QTabBar::tab {
                    background: #e0e0e0;
                    padding: 5px;
                    border: 1px solid #ccc;
                    border-bottom: none;
                    border-top-left-radius: 4px;
                    border-top-right-radius: 4px;
                }
                QTabBar::tab:selected {
                    background: #f0f0f0;
                }
            """)
        else:
            self.setStyleSheet("""
                QMainWindow {
                    background: #333;
                }
                QLabel {
                    color: #eee;
                }
                QPushButton {
                    background: #2E7D32;
                    color: white;
                    border: none;
                    padding: 8px;
                    border-radius: 4px;
                    font-weight: bold;
                }
                QPushButton:hover {
                    background: #1B5E20;
                }
                QSpinBox {
                    padding: 5px;
                    background: #444;
                    color: #eee;
                }
                QGroupBox {
                    border: 1px solid #555;
                    border-radius: 5px;
                    margin-top: 10px;
                    color: #eee;
                }
                QGroupBox::title {
                    subcontrol-origin: margin;
                    left: 10px;
                    padding: 0 3px;
                    color: #eee;
                }
                QTabWidget::pane {
                    border: 1px solid #555;
                    background: #444;
                }
                QTabBar::tab {
                    background: #555;
                    color: #eee;
                    padding: 5px;
                    border: 1px solid #555;
                    border-bottom: none;
                    border-top-left-radius: 4px;
                    border-top-right-radius: 4px;
                }
                QTabBar::tab:selected {
                    background: #444;
                }
            """)

        # –°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ —Å—Ç–∏–ª–∏
        self.spin_button.setStyleSheet("""
            background: #e74c3c;
            color: white;
            font-size: 18px;
            padding: 15px;
        """)
        
        # –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∏–ª–∏ —Å–ª–æ—Ç–æ–≤
        for slot in self.slot_labels:
            slot.setStyleSheet("""
                background: #f0f0f0;
                border: 3px solid #d0d0d0;
                border-radius: 10px;
                font-size: 80px;
            """)

    def set_bet(self, amount):
        self.current_bet = min(amount, self.balance)
        self.bet_spinbox.setValue(self.current_bet)

    def update_bet(self):
        self.current_bet = min(self.bet_spinbox.value(), self.balance)
        self.bet_spinbox.setMaximum(self.balance)

    def update_slot_display(self):
        symbols = ["üçí", "üçã", "üçä", "üçá", "üîî", "‚≠ê", "7"]
        for i, label in enumerate(self.slot_labels):
            label.setText(symbols[self.slot_results[i]])

    def start_spin(self):
        if self.game_active:
            return

        if self.balance < self.current_bet:
            QMessageBox.warning(self, "–û—à–∏–±–∫–∞", "–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤!")
            return

        self.balance -= self.current_bet
        self.update_balance()

        self.game_active = True
        self.spin_counter = 0
        self.spin_timer.start(50)
        
        if self.settings["sound"]:
            self.spin_sound.play()
            
        self.spin_button.setEnabled(False)
        
        # –ù–∞—á–∞–ª—å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –¥–ª—è –∞–Ω–∏–º–∞—Ü–∏–∏
        self.slot_animation_values = [0, 0, 0]

    def update_slot_animation(self):
        # –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏—è –∞–Ω–∏–º–∞—Ü–∏–∏ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Å–ª–æ—Ç–∞
        for i in range(3):
            self.slot_animation_values[i] += random.randint(1, 3)
            self.slot_results[i] = self.slot_animation_values[i] % 7
        
        self.update_slot_display()

        self.spin_counter += 1
        
        # –ó–∞–º–µ–¥–ª—è–µ–º –∞–Ω–∏–º–∞—Ü–∏—é –±–ª–∏–∂–µ –∫ –∫–æ–Ω—Ü—É
        if self.spin_counter > self.spin_duration * 0.7:
            self.spin_timer.setInterval(100)
        elif self.spin_counter > self.spin_duration * 0.4:
            self.spin_timer.setInterval(75)
            
        if self.spin_counter >= self.spin_duration:
            self.finish_spin()

    def finish_spin(self):
        self.spin_timer.stop()
        self.spin_timer.setInterval(50)  # –°–±—Ä–∞—Å—ã–≤–∞–µ–º –∏–Ω—Ç–µ—Ä–≤–∞–ª
        
        self.generate_final_results()
        win = self.check_win()
        
        # –û–±–Ω–æ–≤–ª—è–µ–º –±–∞–ª–∞–Ω—Å –∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
        self.balance += win
        self.last_win = win
        self.update_balance()
        
        # –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
        self.stats["total_spins"] += 1
        if win > 0:
            self.stats["total_wins"] += 1
            self.stats["total_won"] += win
            if win > self.stats["max_win"]:
                self.stats["max_win"] = win
        else:
            self.stats["total_losses"] += 1
            self.stats["total_lost"] += self.current_bet
        
        # –î–æ–±–∞–≤–ª—è–µ–º –≤ –∏—Å—Ç–æ—Ä–∏—é
        self.add_to_history(win)
        self.update_plot()
        self.update_stats_display()
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è
        self.check_achievements(win)
        
        # –î–æ–±–∞–≤–ª—è–µ–º –æ–ø—ã—Ç
        self.add_experience(win)
        
        self.spin_button.setEnabled(True)
        self.game_active = False

        if win > 0:
            self.show_win(win)
            
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–≥—Ä—É –ø–æ—Å–ª–µ –∫–∞–∂–¥–æ–≥–æ —Å–ø–∏–Ω–∞
        self.save_game()

    def generate_final_results(self):
        # –í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç–∏
        jackpot_chance = 0.01  # 1% –Ω–∞ –¥–∂–µ–∫–ø–æ—Ç
        big_win_chance = 0.05  # 5% –Ω–∞ –±–æ–ª—å—à–æ–π –≤—ã–∏–≥—Ä—ã—à
        small_win_chance = 0.3  # 30% –Ω–∞ –º–∞–ª–µ–Ω—å–∫–∏–π –≤—ã–∏–≥—Ä—ã—à
        
        rand = random.random()
        
        if rand < jackpot_chance:  # –î–∂–µ–∫–ø–æ—Ç
            self.slot_results = [6, 6, 6]
        elif rand < jackpot_chance + big_win_chance:  # –ë–æ–ª—å—à–æ–π –≤—ã–∏–≥—Ä—ã—à (3 –æ–¥–∏–Ω–∞–∫–æ–≤—ã—Ö)
            symbol = random.randint(0, 5)  # –õ—é–±–æ–π —Å–∏–º–≤–æ–ª –∫—Ä–æ–º–µ 7
            self.slot_results = [symbol, symbol, symbol]
        elif rand < jackpot_chance + big_win_chance + small_win_chance:  # –ú–∞–ª–µ–Ω—å–∫–∏–π –≤—ã–∏–≥—Ä—ã—à (2 –æ–¥–∏–Ω–∞–∫–æ–≤—ã—Ö)
            symbol = random.randint(0, 5)
            pos = random.sample([0, 1, 2], 2)
            self.slot_results[pos[0]] = symbol
            self.slot_results[pos[1]] = symbol
            self.slot_results[3 - sum(pos)] = random.randint(0, 5)
        else:  # –ù–µ—Ç –≤—ã–∏–≥—Ä—ã—à–∞
            self.slot_results = [random.randint(0, 5) for _ in range(3)]

    def check_win(self):
        a, b, c = self.slot_results
        
        # –î–∂–µ–∫–ø–æ—Ç (—Ç—Ä–∏ —Å–µ–º–µ—Ä–∫–∏)
        if a == b == c == 6:
            return self.current_bet * 100
        
        # –¢—Ä–∏ –æ–¥–∏–Ω–∞–∫–æ–≤—ã—Ö —Å–∏–º–≤–æ–ª–∞
        if a == b == c:
            return self.current_bet * 10
        
        # –î–≤–∞ –æ–¥–∏–Ω–∞–∫–æ–≤—ã—Ö —Å–∏–º–≤–æ–ª–∞
        if a == b or a == c or b == c:
            return self.current_bet * 2
        
        return 0

    def update_balance(self):
        self.balance_label.setText(f"–ë–∞–ª–∞–Ω—Å: ${self.balance:,}")
        self.last_win_label.setText(f"–ü–æ—Å–ª–µ–¥–Ω–∏–π –≤—ã–∏–≥—Ä—ã—à: ${self.last_win:,}")
        self.bet_spinbox.setMaximum(self.balance)

    def add_to_history(self, win):
        symbols = ["üçí", "üçã", "üçä", "üçá", "üîî", "‚≠ê", "7"]
        combo = "".join(symbols[i] for i in self.slot_results)

        if win > 0:
            text = f"{combo} - –í—ã–∏–≥—Ä—ã—à ${win:,}"
            color = "green"
            if self.settings["sound"]:
                if win >= self.current_bet * 100:  # –î–∂–µ–∫–ø–æ—Ç
                    self.jackpot_sound.play()
                else:
                    self.win_sound.play()
        else:
            text = f"{combo} - –ü—Ä–æ–∏–≥—Ä—ã—à ${self.current_bet:,}"
            color = "red"
            if self.settings["sound"]:
                self.lose_sound.play()

        self.history.insert(0, (text, color))
        if len(self.history) > 10:
            self.history = self.history[:10]

        history_text = "<br>".join(f'<font color="{c}">{t}</font>' for t, c in self.history)
        self.history_display.setText(history_text)

    def update_plot(self):
        self.balance_history.append(self.balance)
        self.plot_line.setData(self.balance_history)

    def show_win(self, amount):
        if not self.settings["animations"]:
            return
            
        self.win_animation.setText(f"–ü–û–ë–ï–î–ê! ${amount:,}")
        self.win_animation.show()
        self.win_animation.setStyleSheet("color: gold;")
        
        # –ê–Ω–∏–º–∞—Ü–∏—è —É–≤–µ–ª–∏—á–µ–Ω–∏—è
        anim = QPropertyAnimation(self.win_animation, b"geometry")
        anim.setDuration(1000)
        anim.setEasingCurve(QEasingCurve.OutElastic)
        
        start_rect = QRect(
            self.win_animation.x(),
            self.win_animation.y(),
            self.win_animation.width(),
            self.win_animation.height()
        )
        
        end_rect = QRect(
            self.win_animation.x() - 20,
            self.win_animation.y() - 20,
            self.win_animation.width() + 40,
            self.win_animation.height() + 40
        )
        
        anim.setStartValue(start_rect)
        anim.setEndValue(end_rect)
        anim.start()
        
        QTimer.singleShot(3000, self.win_animation.hide)

    def reset_game(self):
        if QMessageBox.question(self, "–°–±—Ä–æ—Å", "–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —Å–±—Ä–æ—Å–∏—Ç—å –∏–≥—Ä—É? –í—Å–µ –ø—Ä–æ–≥—Ä–µ—Å—Å –±—É–¥–µ—Ç –ø–æ—Ç–µ—Ä—è–Ω.") == QMessageBox.Yes:
            self.balance = 1000
            self.current_bet = 10
            self.last_win = 0
            self.history = []
            self.balance_history = [self.balance]
            
            # –°–±—Ä–æ—Å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
            self.stats = {
                "total_spins": 0,
                "total_wins": 0,
                "total_losses": 0,
                "max_win": 0,
                "total_won": 0,
                "total_lost": 0
            }
            
            # –°–±—Ä–æ—Å —É—Ä–æ–≤–Ω–µ–π
            self.level = 1
            self.exp = 0
            self.exp_to_next_level = 100
            
            # –°–±—Ä–æ—Å –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–π
            self.achievements = {
                "first_win": False,
                "big_win": False,
                "jackpot": False,
                "high_roller": False,
                "veteran": False
            }
            
            self.bet_spinbox.setValue(10)
            self.update_balance()
            self.history_display.setText("")
            self.plot_line.setData(self.balance_history)
            self.update_stats_display()
            self.update_achievements_display()
            
            self.slot_results = [0, 0, 0]
            self.update_slot_display()
            
            # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–±—Ä–æ—à–µ–Ω–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
            self.save_game()

    def calculate_win_rate(self):
        if self.stats["total_spins"] == 0:
            return 0
        return (self.stats["total_wins"] / self.stats["total_spins"]) * 100

    def update_stats_display(self):
        self.stats_labels["total_spins"].setText(f"–í—Å–µ–≥–æ —Å–ø–∏–Ω–æ–≤: {self.stats['total_spins']}")
        self.stats_labels["total_wins"].setText(f"–ü–æ–±–µ–¥: {self.stats['total_wins']}")
        self.stats_labels["total_losses"].setText(f"–ü–æ—Ä–∞–∂–µ–Ω–∏–π: {self.stats['total_losses']}")
        self.stats_labels["win_rate"].setText(f"–ü—Ä–æ—Ü–µ–Ω—Ç –ø–æ–±–µ–¥: {self.calculate_win_rate():.1f}%")
        self.stats_labels["max_win"].setText(f"–ú–∞–∫—Å. –≤—ã–∏–≥—Ä—ã—à: ${self.stats['max_win']:,}")
        self.stats_labels["total_won"].setText(f"–í—Å–µ–≥–æ –≤—ã–∏–≥—Ä–∞–Ω–æ: ${self.stats['total_won']:,}")
        self.stats_labels["total_lost"].setText(f"–í—Å–µ–≥–æ –ø—Ä–æ–∏–≥—Ä–∞–Ω–æ: ${self.stats['total_lost']:,}")

    def check_achievements(self, win):
        # –ü–µ—Ä–≤–∞—è –ø–æ–±–µ–¥–∞
        if not self.achievements["first_win"] and win > 0:
            self.achievements["first_win"] = True
            self.show_achievement("–ü–µ—Ä–≤–∞—è –ø–æ–±–µ–¥–∞!")
            
        # –ë–æ–ª—å—à–æ–π –≤—ã–∏–≥—Ä—ã—à
        if not self.achievements["big_win"] and win >= 500:
            self.achievements["big_win"] = True
            self.show_achievement("–ë–æ–ª—å—à–æ–π –≤—ã–∏–≥—Ä—ã—à!")
            
        # –î–∂–µ–∫–ø–æ—Ç
        if not self.achievements["jackpot"] and win >= self.current_bet * 100:
            self.achievements["jackpot"] = True
            self.show_achievement("–î–∂–µ–∫–ø–æ—Ç!!!")
            
        # –í—ã—Å–æ–∫–∞—è —Å—Ç–∞–≤–∫–∞
        if not self.achievements["high_roller"] and self.current_bet >= 1000:
            self.achievements["high_roller"] = True
            self.show_achievement("–í—ã—Å–æ–∫–∞—è —Å—Ç–∞–≤–∫–∞!")
            
        # –í–µ—Ç–µ—Ä–∞–Ω
        if not self.achievements["veteran"] and self.stats["total_spins"] >= 100:
            self.achievements["veteran"] = True
            self.show_achievement("–í–µ—Ç–µ—Ä–∞–Ω –∫–∞–∑–∏–Ω–æ!")
            
        self.update_achievements_display()

    def update_achievements_display(self):
        self.achievement_labels["first_win"].setText(
            "–ü–µ—Ä–≤–∞—è –ø–æ–±–µ–¥–∞: ‚úÖ" if self.achievements["first_win"] else "–ü–µ—Ä–≤–∞—è –ø–æ–±–µ–¥–∞: ‚ùå"
        )
        self.achievement_labels["big_win"].setText(
            "–ë–æ–ª—å—à–æ–π –≤—ã–∏–≥—Ä—ã—à (500+): ‚úÖ" if self.achievements["big_win"] else "–ë–æ–ª—å—à–æ–π –≤—ã–∏–≥—Ä—ã—à (500+): ‚ùå"
        )
        self.achievement_labels["jackpot"].setText(
            "–î–∂–µ–∫–ø–æ—Ç (777): ‚úÖ" if self.achievements["jackpot"] else "–î–∂–µ–∫–ø–æ—Ç (777): ‚ùå"
        )
        self.achievement_labels["high_roller"].setText(
            "–í—ã—Å–æ–∫–∞—è —Å—Ç–∞–≤–∫–∞ (1000+): ‚úÖ" if self.achievements["high_roller"] else "–í—ã—Å–æ–∫–∞—è —Å—Ç–∞–≤–∫–∞ (1000+): ‚ùå"
        )
        self.achievement_labels["veteran"].setText(
            "–í–µ—Ç–µ—Ä–∞–Ω (100 —Å–ø–∏–Ω–æ–≤): ‚úÖ" if self.achievements["veteran"] else "–í–µ—Ç–µ—Ä–∞–Ω (100 —Å–ø–∏–Ω–æ–≤): ‚ùå"
        )

    def show_achievement(self, text):
        msg = QMessageBox()
        msg.setIcon(QMessageBox.Information)
        msg.setText("–î–æ—Å—Ç–∏–∂–µ–Ω–∏–µ —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ!")
        msg.setInformativeText(text)
        msg.setWindowTitle("–ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º!")
        msg.exec_()

    def add_experience(self, win):
        # –ë–∞–∑–æ–≤—ã–π –æ–ø—ã—Ç –∑–∞ —Å–ø–∏–Ω
        base_exp = 5
        
        # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π –æ–ø—ã—Ç –∑–∞ –≤—ã–∏–≥—Ä—ã—à
        if win > 0:
            base_exp += win // 10
            
        self.exp += base_exp
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ —É—Ä–æ–≤–Ω—è
        if self.exp >= self.exp_to_next_level:
            self.level_up()
            
        self.update_level_display()

    def level_up(self):
        self.level += 1
        self.exp -= self.exp_to_next_level
        self.exp_to_next_level = int(self.exp_to_next_level * 1.5)
        
        # –ë–æ–Ω—É—Å –∑–∞ —É—Ä–æ–≤–µ–Ω—å
        bonus = self.level * 50
        self.balance += bonus
        
        msg = QMessageBox()
        msg.setIcon(QMessageBox.Information)
        msg.setText(f"–ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º! –í—ã –¥–æ—Å—Ç–∏–≥–ª–∏ {self.level} —É—Ä–æ–≤–Ω—è!")
        msg.setInformativeText(f"–í—ã –ø–æ–ª—É—á–∏–ª–∏ –±–æ–Ω—É—Å: ${bonus:,}")
        msg.setWindowTitle("–ù–æ–≤—ã–π —É—Ä–æ–≤–µ–Ω—å!")
        msg.exec_()
        
        self.update_balance()
        
        # –ï—Å–ª–∏ –ø–æ—Å–ª–µ –ø–æ–≤—ã—à–µ–Ω–∏—è —É—Ä–æ–≤–Ω—è –æ—Å—Ç–∞–ª–æ—Å—å –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –æ–ø—ã—Ç–∞ –¥–ª—è —Å–ª–µ–¥—É—é—â–µ–≥–æ —É—Ä–æ–≤–Ω—è
        if self.exp >= self.exp_to_next_level:
            self.level_up()

    def update_level_display(self):
        self.level_label.setText(f"–£—Ä–æ–≤–µ–Ω—å: {self.level}")
        self.exp_bar.setMaximum(self.exp_to_next_level)
        self.exp_bar.setValue(self.exp)

    def check_daily_bonus(self):
        today = QDate.currentDate().toString("yyyy-MM-dd")
        
        if self.last_bonus_date == today:
            return
            
        # –ï—Å–ª–∏ –±–æ–Ω—É—Å —É–∂–µ –ø–æ–ª—É—á–∞–ª–∏ —Å–µ–≥–æ–¥–Ω—è, –Ω–µ –¥–∞–µ–º –µ—â–µ —Ä–∞–∑
        if self.last_bonus_date is None or self.last_bonus_date != today:
            # –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º —Å–µ—Ä–∏—é, –µ—Å–ª–∏ –±–æ–Ω—É—Å –ø–æ–ª—É—á–∞–ª–∏ –≤—á–µ—Ä–∞
            if self.last_bonus_date == QDate.currentDate().addDays(-1).toString("yyyy-MM-dd"):
                self.bonus_streak += 1
            else:
                self.bonus_streak = 1
                
            # –í—ã—á–∏—Å–ª—è–µ–º –±–æ–Ω—É—Å
            bonus = 100 + (self.bonus_streak - 1) * 50
            self.balance += bonus
            self.last_bonus_date = today
            
            msg = QMessageBox()
            msg.setIcon(QMessageBox.Information)
            msg.setText("–ï–∂–µ–¥–Ω–µ–≤–Ω—ã–π –±–æ–Ω—É—Å!")
            msg.setInformativeText(f"–í—ã –ø–æ–ª—É—á–∏–ª–∏ ${bonus:,} –∑–∞ {self.bonus_streak} –¥–µ–Ω—å –ø–æ–¥—Ä—è–¥!")
            msg.setWindowTitle("–ë–æ–Ω—É—Å!")
            msg.exec_()
            
            self.update_balance()
            self.save_game()

    def show_settings(self):
        settings_dialog = QWidget()
        settings_dialog.setWindowTitle("–ù–∞—Å—Ç—Ä–æ–π–∫–∏")
        settings_dialog.setFixedSize(400, 300)
        
        layout = QVBoxLayout()
        
        # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∑–≤—É–∫–æ–≤
        sound_group = QGroupBox("–ó–≤—É–∫–∏")
        sound_layout = QVBoxLayout()
        
        sound_check = QCheckBox("–í–∫–ª—é—á–∏—Ç—å –∑–≤—É–∫–∏")
        sound_check.setChecked(self.settings["sound"])
        sound_check.stateChanged.connect(lambda state: self.toggle_setting("sound", state))
        
        music_check = QCheckBox("–í–∫–ª—é—á–∏—Ç—å –º—É–∑—ã–∫—É")
        music_check.setChecked(self.settings["music"])
        music_check.stateChanged.connect(lambda state: self.toggle_setting("music", state))
        
        sound_layout.addWidget(sound_check)
        sound_layout.addWidget(music_check)
        sound_group.setLayout(sound_layout)
        layout.addWidget(sound_group)
        
        # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ç–µ–º—ã
        theme_group = QGroupBox("–¢–µ–º–∞ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è")
        theme_layout = QVBoxLayout()
        
        theme_combo = QComboBox()
        theme_combo.addItems(["–°–≤–µ—Ç–ª–∞—è", "–¢–µ–º–Ω–∞—è"])
        theme_combo.setCurrentIndex(0 if self.settings["theme"] == "light" else 1)
        theme_combo.currentIndexChanged.connect(self.change_theme)
        
        theme_layout.addWidget(theme_combo)
        theme_group.setLayout(theme_layout)
        layout.addWidget(theme_group)
        
        # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∞–Ω–∏–º–∞—Ü–∏–π
        anim_group = QGroupBox("–ê–Ω–∏–º–∞—Ü–∏–∏")
        anim_layout = QVBoxLayout()
        
        anim_check = QCheckBox("–í–∫–ª—é—á–∏—Ç—å –∞–Ω–∏–º–∞—Ü–∏–∏")
        anim_check.setChecked(self.settings["animations"])
        anim_check.stateChanged.connect(lambda state: self.toggle_setting("animations", state))
        
        anim_layout.addWidget(anim_check)
        anim_group.setLayout(anim_layout)
        layout.addWidget(anim_group)
        
        # –ö–Ω–æ–ø–∫–∞ –∑–∞–∫—Ä—ã—Ç–∏—è
        close_btn = QPushButton("–ó–∞–∫—Ä—ã—Ç—å")
        close_btn.clicked.connect(settings_dialog.close)
        layout.addWidget(close_btn)
        
        settings_dialog.setLayout(layout)
        settings_dialog.exec_()

    def toggle_setting(self, setting, state):
        self.settings[setting] = state == Qt.Checked
        self.save_game()

    def change_theme(self, index):
        self.settings["theme"] = "light" if index == 0 else "dark"
        self.apply_theme()
        self.save_game()

    def save_game(self):
        save_data = {
            "balance": self.balance,
            "level": self.level,
            "exp": self.exp,
            "exp_to_next_level": self.exp_to_next_level,
            "stats": self.stats,
            "achievements": self.achievements,
            "last_bonus_date": self.last_bonus_date,
            "bonus_streak": self.bonus_streak,
            "settings": self.settings,
            "balance_history": self.balance_history[-100:],  # –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ 100 –∑–Ω–∞—á–µ–Ω–∏–π
            "history": self.history
        }
        
        try:
            with open("casino_save.json", "w") as f:
                json.dump(save_data, f)
        except Exception as e:
            print(f"–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: {e}")

    def load_game(self):
        save_file = Path("casino_save.json")
        if not save_file.exists():
            return
            
        try:
            with open("casino_save.json", "r") as f:
                save_data = json.load(f)
                
            self.balance = save_data.get("balance", 1000)
            self.level = save_data.get("level", 1)
            self.exp = save_data.get("exp", 0)
            self.exp_to_next_level = save_data.get("exp_to_next_level", 100)
            self.stats = save_data.get("stats", {
                "total_spins": 0,
                "total_wins": 0,
                "total_losses": 0,
                "max_win": 0,
                "total_won": 0,
                "total_lost": 0
            })
            self.achievements = save_data.get("achievements", {
                "first_win": False,
                "big_win": False,
                "jackpot": False,
                "high_roller": False,
                "veteran": False
            })
            self.last_bonus_date = save_data.get("last_bonus_date")
            self.bonus_streak = save_data.get("bonus_streak", 0)
            self.settings = save_data.get("settings", {
                "sound": True,
                "music": True,
                "theme": "light",
                "animations": True
            })
            self.balance_history = save_data.get("balance_history", [self.balance])
            self.history = save_data.get("history", [])
            
        except Exception as e:
            print(f"–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: {e}")


if __name__ == "__main__":
    app = QApplication(sys.argv)
    app.setStyle("Fusion")
    
    # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∏–∫–æ–Ω–∫—É –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
    try:
        app.setWindowIcon(QIcon("casino_icon.png"))
    except:
        pass

    game = CasinoGame()
    game.show()

    sys.exit(app.exec_())
